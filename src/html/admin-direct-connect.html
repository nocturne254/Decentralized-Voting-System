<!DOCTYPE html>
<html>
<head>
    <title>Admin Portal - Direct Connect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1, h2 {
            color: #006400;
        }
        
        .container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .date-group {
            display: flex;
            gap: 10px;
        }
        
        .date-group input {
            width: 70px;
        }
        
        .date-separator {
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .debug-info {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>MUT Voting System - Admin Portal</h1>
    
    <div class="container">
        <h2>MetaMask Connection</h2>
        <p>First, connect to MetaMask to access admin functions:</p>
        
        <button id="connectBtn">Connect to MetaMask</button>
        <div id="connectionStatus" class="status warning">Not connected to MetaMask</div>
        
        <div id="accountInfo" class="hidden">
            <h3>Account Information</h3>
            <p><strong>Address:</strong> <span id="accountAddress"></span></p>
            <p><strong>Network:</strong> <span id="networkName"></span></p>
            <p><strong>Chain ID:</strong> <span id="chainId"></span></p>
        </div>
    </div>
    
    <div id="adminFunctions" class="hidden">
        <div class="container">
            <h2>Create New Election</h2>
            
            <form id="electionForm">
                <div class="form-group">
                    <label for="electionName">Election Name:</label>
                    <input type="text" id="electionName" placeholder="e.g., Student Council Elections 2025" required>
                </div>
                
                <div class="form-group">
                    <label>Start Date (DD/MM/YYYY):</label>
                    <div class="date-group">
                        <input type="number" id="startDay" min="1" max="31" placeholder="DD" value="1" required>
                        <span class="date-separator">/</span>
                        <input type="number" id="startMonth" min="1" max="12" placeholder="MM" value="5" required>
                        <span class="date-separator">/</span>
                        <input type="number" id="startYear" min="2025" max="2030" placeholder="YYYY" value="2025" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>End Date (DD/MM/YYYY):</label>
                    <div class="date-group">
                        <input type="number" id="endDay" min="1" max="31" placeholder="DD" value="10" required>
                        <span class="date-separator">/</span>
                        <input type="number" id="endMonth" min="1" max="12" placeholder="MM" value="5" required>
                        <span class="date-separator">/</span>
                        <input type="number" id="endYear" min="2025" max="2030" placeholder="YYYY" value="2025" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="candidate1">Candidate 1:</label>
                    <input type="text" id="candidate1" placeholder="Candidate Name" required>
                </div>
                
                <div class="form-group">
                    <label for="candidate2">Candidate 2:</label>
                    <input type="text" id="candidate2" placeholder="Candidate Name" required>
                </div>
                
                <div id="additionalCandidates"></div>
                
                <button type="button" id="addCandidateBtn">Add Another Candidate</button>
                <button type="submit">Create Election</button>
            </form>
            
            <div id="formStatus" class="status hidden"></div>
        </div>
    </div>
    
    <div class="debug-info" id="debugInfo">
        Debug information will appear here...
    </div>
    
    <script>
        // Global variables
        let web3;
        let accounts = [];
        let isConnected = false;
        let candidateCount = 2;
        
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const accountInfo = document.getElementById('accountInfo');
        const accountAddress = document.getElementById('accountAddress');
        const networkName = document.getElementById('networkName');
        const chainId = document.getElementById('chainId');
        const adminFunctions = document.getElementById('adminFunctions');
        const electionForm = document.getElementById('electionForm');
        const addCandidateBtn = document.getElementById('addCandidateBtn');
        const additionalCandidates = document.getElementById('additionalCandidates');
        const formStatus = document.getElementById('formStatus');
        const debugInfo = document.getElementById('debugInfo');
        
        // Log function for debugging
        function log(message) {
            console.log(message);
            debugInfo.textContent += "\n" + message;
            
            // Scroll to bottom of debug info
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Initialize
        function init() {
            log("Initializing application...");
            
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                log("MetaMask is installed!");
                
                // Add event listeners
                connectBtn.addEventListener('click', connectToMetaMask);
                addCandidateBtn.addEventListener('click', addCandidate);
                electionForm.addEventListener('submit', createElection);
                
                // Check if already connected
                checkConnection();
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                
                // Listen for chain changes
                window.ethereum.on('chainChanged', handleChainChanged);
            } else {
                log("MetaMask is not installed!");
                connectionStatus.className = "status error";
                connectionStatus.textContent = "MetaMask is not installed. Please install MetaMask extension and refresh this page.";
                connectBtn.disabled = true;
            }
        }
        
        // Check if already connected to MetaMask
        async function checkConnection() {
            try {
                log("Checking existing connection...");
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length > 0) {
                    log("Already connected to account: " + accounts[0]);
                    handleAccountsChanged(accounts);
                } else {
                    log("Not connected to any accounts.");
                }
            } catch (error) {
                log("Error checking connection: " + error.message);
            }
        }
        
        // Connect to MetaMask
        async function connectToMetaMask() {
            try {
                log("Requesting connection to MetaMask...");
                connectionStatus.className = "status warning";
                connectionStatus.textContent = "Connecting to MetaMask...";
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
            } catch (error) {
                log("Error connecting to MetaMask: " + error.message);
                connectionStatus.className = "status error";
                connectionStatus.textContent = "Error connecting to MetaMask: " + error.message;
            }
        }
        
        // Handle accounts changed
        function handleAccountsChanged(newAccounts) {
            if (newAccounts.length === 0) {
                log("Disconnected from MetaMask");
                isConnected = false;
                connectionStatus.className = "status warning";
                connectionStatus.textContent = "Disconnected from MetaMask";
                accountInfo.classList.add('hidden');
                adminFunctions.classList.add('hidden');
            } else {
                log("Connected to account: " + newAccounts[0]);
                accounts = newAccounts;
                isConnected = true;
                
                // Update UI
                connectionStatus.className = "status success";
                connectionStatus.textContent = "Connected to MetaMask";
                accountAddress.textContent = accounts[0];
                accountInfo.classList.remove('hidden');
                adminFunctions.classList.remove('hidden');
                
                // Get network information
                getNetworkInfo();
            }
        }
        
        // Handle chain changed
        function handleChainChanged(newChainId) {
            log("Chain changed to: " + newChainId);
            chainId.textContent = newChainId;
            getNetworkInfo();
            
            // Reload the page
            window.location.reload();
        }
        
        // Get network information
        async function getNetworkInfo() {
            try {
                const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
                chainId.textContent = chainIdHex;
                
                // Determine network name
                let network = "Unknown Network";
                
                switch (chainIdHex) {
                    case "0x1":
                        network = "Ethereum Mainnet";
                        break;
                    case "0x3":
                        network = "Ropsten Testnet";
                        break;
                    case "0x4":
                        network = "Rinkeby Testnet";
                        break;
                    case "0x5":
                        network = "Goerli Testnet";
                        break;
                    case "0x539":
                        network = "Ganache Local";
                        break;
                    default:
                        network = "Local Network (" + chainIdHex + ")";
                }
                
                networkName.textContent = network;
                log("Connected to network: " + network);
            } catch (error) {
                log("Error getting network info: " + error.message);
            }
        }
        
        // Add candidate
        function addCandidate() {
            candidateCount++;
            log("Adding candidate #" + candidateCount);
            
            const candidateDiv = document.createElement('div');
            candidateDiv.className = 'form-group';
            candidateDiv.innerHTML = `
                <label for="candidate${candidateCount}">Candidate ${candidateCount}:</label>
                <input type="text" id="candidate${candidateCount}" placeholder="Candidate Name" required>
            `;
            
            additionalCandidates.appendChild(candidateDiv);
        }
        
        // Create election
        async function createElection(event) {
            event.preventDefault();
            
            if (!isConnected) {
                formStatus.className = "status error";
                formStatus.textContent = "Please connect to MetaMask first.";
                formStatus.classList.remove('hidden');
                return;
            }
            
            // Get form values
            const electionName = document.getElementById('electionName').value;
            const startDay = document.getElementById('startDay').value;
            const startMonth = document.getElementById('startMonth').value;
            const startYear = document.getElementById('startYear').value;
            const endDay = document.getElementById('endDay').value;
            const endMonth = document.getElementById('endMonth').value;
            const endYear = document.getElementById('endYear').value;
            
            // Format dates
            const startDate = `${startDay}/${startMonth}/${startYear}`;
            const endDate = `${endDay}/${endMonth}/${endYear}`;
            
            // Get candidates
            const candidates = [];
            for (let i = 1; i <= candidateCount; i++) {
                const candidateInput = document.getElementById(`candidate${i}`);
                if (candidateInput && candidateInput.value) {
                    candidates.push(candidateInput.value);
                }
            }
            
            // Validate form
            if (!electionName) {
                formStatus.className = "status error";
                formStatus.textContent = "Please enter an election name.";
                formStatus.classList.remove('hidden');
                return;
            }
            
            if (candidates.length < 2) {
                formStatus.className = "status error";
                formStatus.textContent = "Please add at least two candidates.";
                formStatus.classList.remove('hidden');
                return;
            }
            
            log("Creating election: " + electionName);
            log("Start date: " + startDate);
            log("End date: " + endDate);
            log("Candidates: " + candidates.join(", "));
            
            // Show success message (in a real app, this would interact with the blockchain)
            formStatus.className = "status success";
            formStatus.innerHTML = `
                <h3>Election Created Successfully!</h3>
                <p><strong>Name:</strong> ${electionName}</p>
                <p><strong>Period:</strong> ${startDate} to ${endDate}</p>
                <p><strong>Candidates:</strong></p>
                <ul>
                    ${candidates.map(name => `<li>${name}</li>`).join('')}
                </ul>
            `;
            formStatus.classList.remove('hidden');
        }
        
        // Initialize the application
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
